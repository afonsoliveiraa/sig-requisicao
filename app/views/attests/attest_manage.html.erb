<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Loopple/loopple-public-assets@main/riva-dashboard-tailwind/riva-dashboard.css">

<div class="flex flex-wrap -mx-3 mb-5">
  <div class="w-full max-w-full px-3 mb-6 mx-auto">
    <div class="relative flex-[1_auto] flex flex-col break-words min-w-0 bg-clip-border rounded-[.95rem] bg-white m-5">
      <div class="relative flex flex-col min-w-0 break-words border border-dashed bg-clip-border rounded-2xl border-stone-200 bg-light/30">
        <div class="px-9 pt-5 flex justify-between items-stretch flex-wrap min-h-[70px] pb-0 bg-transparent">
          <h3 class="flex flex-col items-start justify-center m-2 ml-0 font-medium text-xl/tight text-dark">
            <span class="mr-3 font-semibold text-dark">Signatures for Attest #<%= @attest.id %></span>
            <span class="mt-1 font-medium text-secondary-dark text-lg/normal">List of all signatures</span>
          </h3>
        </div>
        <div class="flex-auto block py-8 pt-6 px-9">
          <div class="overflow-x-auto">
            <table class="w-full my-0 align-middle text-dark border-neutral-200">
              <thead class="align-bottom">
                <tr class="font-semibold text-[0.95rem] text-secondary-dark">
                  <th class="pb-3 text-start min-w-[175px]">Name</th>
                  <th class="pb-3 text-start min-w-[150px]">Email</th>
                  <th class="pb-3 text-start min-w-[100px]">CPF</th>
                  <th class="pb-3 text-start min-w-[150px]">Title</th>
                  <th class="pb-3 text-start min-w-[175px]">Status</th>
                  <th class="pb-3 text-start min-w-[175px]">Signed At</th>
                  <th class="pb-3 text-end min-w-[100px]">Actions</th>
                </tr>
              </thead>
              <tbody>
                <% @attest.signatures.each do |signature| %>
                  <tr class="border-b border-dashed last:border-b-0" id="signature-row-<%= signature.id %>">
                    <td class="p-3 pl-0 font-medium"><%= signature.name %></td>

                    <td class="p-3 pl-0" id="email-cell-<%= signature.id %>">
                      <span id="email-display-<%= signature.id %>"><%= signature.email %></span>

                      <%= form_with model: signature,
                                    url: update_email_signature_path(signature),
                                    method: :patch,
                                    local: true,
                                    html: { id: "edit-form-#{signature.id}", class: "hidden mt-2" } do |f| %>
                        <div class="mb-3">
                          <%= f.label :email, "Email", class: "block mb-1 font-medium text-[#07074D]" %>
                          <%= f.email_field :email,
                                            value: signature.email,
                                            required: true,
                                            class: "w-full rounded-md border border-[#e0e0e0] py-2 px-3 text-base outline-none" %>
                        </div>
                        <div>
                          <%= f.submit "Salvar",
                                       class: "mr-2 bg-primary text-white px-4 py-1 rounded hover:bg-primary-dark cursor-pointer" %>
                          <button type="button" onclick="toggleEdit(<%= signature.id %>)"
                                  class="text-gray-500 hover:text-gray-700">Cancelar</button>
                        </div>
                      <% end %>
                    </td>

                    <td class="p-3 pl-0"><%= signature.cpf %></td>
                    <td class="p-3 pl-0"><%= signature.title %></td>
                    <td class="p-3 pl-0"><%= signature.status %></td>
                    <td class="p-3 pl-0"><%= signature.signed_at.present? ? signature.signed_at.strftime("%Y-%m-%d %H:%M") : "-" %></td>

                    <td class="p-3 text-end">
                    <% if signature.status == 'PENDENTE' %>
                      <button
                        onclick="toggleEdit(<%= signature.id %>)"
                        id="edit-btn-<%= signature.id %>"
                        class="text-primary font-semibold hover:underline"
                      >Editar</button>
                    </td>
                    <% else %>
                      <span class="text-gray-500">N/A</span>    
                    </td>
                    <% end %>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function toggleEdit(id) {
    const form = document.getElementById(`edit-form-${id}`);
    const emailDisplay = document.getElementById(`email-display-${id}`);
    const editBtn = document.getElementById(`edit-btn-${id}`);

    if (form.classList.contains('hidden')) {
      form.classList.remove('hidden');
      emailDisplay.style.display = 'none';
      editBtn.style.display = 'none';
    } else {
      form.classList.add('hidden');
      emailDisplay.style.display = 'inline';
      editBtn.style.display = 'inline-block';
    }
  }
</script>
